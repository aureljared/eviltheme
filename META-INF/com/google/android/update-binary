#!/sbin/sh
# Eviltheme by Jared Dantis (@aureljared)
# Licensed under GPL v3
# https://github.com/aureljared/eviltheme
version="3.0.0"
vrroot="/data/tmp/eviltheme"
vrbackupstaging="/data/tmp/evt-backup"
vrbackup="/data/eviltheme-backup"
vrengine="/tmp/eviltheme"

SYSTEMLESS=0
TIMESTAMP=$(date +"%m%d%y-%H%M%S")
ZIPFILE="$3"

# Extract engine files
rm -rf $vrroot $vrbackupstaging $vrengine && mkdir $vrengine
unzip -o "$ZIPFILE" "META-INF/tk/aureljared/*" "eviltheme.prop" -d $vrengine
find "$vrengine/META-INF/tk/aureljared/eviltheme" -type f -exec mv {} "$vrengine/" \;
chmod -R 0755 $vrengine/*
source $vrengine/recovery-utils.sh
source $vrengine/eviltheme-utils.sh
source $vrengine/eviltheme.prop

# Please don't remove this, thanks!
themeIntro
ui_print "--------------------------------"
ui_print " Eviltheme $version by @aureljared"
ui_print "--------------------------------"

# Mount filesystems
ui_print "Mounting filesystems"
mount -o ro /system
mount /data
mount /preload
set_progress 0.10

# Create working directories
mkdir -p "$vrroot/apply"
mkdir -p "$vrbackupstaging"

# Extract theme files
ui_print "Extracting theme files"
unzip -o "$ZIPFILE" "vrtheme/*" -d /data/tmp
mv /data/tmp/vrtheme $vrroot
mv $vrengine/restore_template.zip $vrroot/
cp -f $vrengine/eviltheme.prop $vrbackupstaging/
set_progress 0.30

# Detect runtime
[ "$(ls -A $vrroot/)" ] && HASTHEMEFILES=1
if [ "$HASTHEMEFILES" -eq "1" ]; then
    echo '' > $vrbackupstaging/bytecode.list
    test -f /system/system/build.prop && root="/system"
    platformString=`cat $root/system/build.prop | grep "^ro.build.version.release=" | cut -d"=" -f2 | tr -d '\r '`
    platform=`echo "$platformString" | cut -d. -f1`
    if [ "$platform" -ge "5" ]; then
        art=1
        ui_print "Detected ART runtime"
        checkdex() {
            appname=$(friendlyname "$2")
            if [ -e ./classes.dex ] || [ -e ./classes.art ]; then
                [ "$root" == "/system" ] && rootDir="system@system" || rootDir="system"
                echo "$rootDir@$1@$appname@$2" >> $vrbackupstaging/bytecode.list
                rm -f "/data/dalvik-cache/arm/$rootdir@$1@$appname@$2@classes.dex"
                rm -f "/data/dalvik-cache/arm64/$rootdir@$1@$appname@$2@classes.dex"
                rm -f "/data/dalvik-cache/arm/$rootdir@$1@$appname@$2@classes.art"
                rm -f "/data/dalvik-cache/arm64/$rootdir@$1@$appname@$2@classes.art"
            fi
        }
    else
        art=0
        ui_print "Detected Dalvik runtime"
        mount /cache
        checkdex() {
            if [ -e ./classes.dex ]; then
                echo "system@$1@$2" >> $vrbackupstaging/bytecode.list
                rm -f "/data/dalvik-cache/system@$1@$2@classes.dex"
                rm -f "/cache/dalvik-cache/system@$1@$2@classes.dex"
            fi
        }
    fi
fi

# Systemless installation detection
suimg=$(ls /data/magisk.img || ls /cache/magisk.img) 2>/dev/null
if [ ! -e "/sdcard/.eviltheme-force-system" ] && [ "$suimg" ]; then
    MAGISKBIN="$(echo $suimg | sed 's~.img~~g')"
    ui_print "Attempting systemless mode"

    # Check for Magisk 13.1+
    ui_print "Analyzing Magisk installation"
    [ -d "$MAGISKBIN" -a -f "$MAGISKBIN/magisk" -a -f "$MAGISKBIN/util_functions.sh" ] && oldMagisk=0 || oldMagisk=1
    if [ "$oldMagisk" -eq "0" ]; then
        SYSTEMLESS=1
        sumnt="/$(basename $suimg .img)"
        
        # Calculate free space
        curBlocks=$(e2fsck -n $suimg 2>/dev/null | grep $suimg | cut -d, -f3 | cut -d\  -f2)
        curUsed=$(echo "$curBlocks" | cut -d/ -f1)
        curSize=$(echo "$curBlocks" | cut -d/ -f2)
        curFreeM=$(((curSize - curUsed) * 4 / 1024))
        curUsedM=$((curUsed * 4 / 1024))
        curSizeM=$((curSize * 4 / 1024))
        ui_print " * Free space: $curFreeM of $curSizeM MB"

        # Calculate size of themed apps
        needAppSizeK=0
        find $vrroot/system -name '*.apk' 2>/dev/null | while read f; do
            if [ "$art" -eq "1" ]; then
                apkFile=$(echo $f | grep -o '[^/]*$')
                newRoot="${root}system"
                apkPath="$(echo $f | sed "s~${vrroot}~~g" | sed "s~/system~${newRoot}~g" | sed 's/.apk//g')/$apkFile"
            else
                apkPath=$(echo $f | sed "s~${vrroot}~~g" | sed "s~/system~${root}system~g")
            fi
            sizeK=$(du -sk $apkPath | cut -f1)
            needAppSizeK=$((sizeK + needAppSizeK))
        done
        [ "$needAppSizeK" -gt "0" ] && needAppSizeM=$((needAppSizeK / 1024)) || needAppSizeM=0
        ui_print " * Theme size: $needAppSizeM MB"

        # Calculate size of new files
        needNewSize=$(unzip -l $ZIPFILE 'system/*' | tr -s ' ' ' ' | tail -1 | cut -d' ' -f2)
        needNewSizeK=$((needNewSize / 1024))
        [ "$needNewSize" -gt "0" ] && needNewSizeM=$((needNewSizeK / 1024)) || needNewSizeM=0
        ui_print " * New files: $needNewSizeM MB"

        # Calculate total theme size
        needSizeM=$(((needAppSizeK + needNewSizeK) / 1024))
        if [ "$needSizeM" -lt "$curFreeM" ]; then
            ui_print " * Free space enough, not resizing."
        else
            newSizeM=$(((needSizeM + curUsedM) + 32))   # 32MB extra
            dataFreeBlocks=$(df -kP /data | tr -s ' ' $'\t' | cut -f4 | grep -vE "^Available")
            dataFreeM=$((dataFreeBlocks / 1024))
            if [ "$dataFreeM" -gt "$newSizeM" ]; then
                ui_print " * Resizing to $needSizeM MB"
                resize2fs $suimg ${needSizeM}M
            else
                ui_print " * Error: /data has too little free space."
                ui_print "   To force a non-systemless installation,"
                ui_print "   create a file called .eviltheme-force-system"
                ui_print "   in your /sdcard."
                cleanup
                exit 1
            fi
        fi

        # Mount image
        ui_print "Mounting magisk.img"
        test ! -e $sumnt && mkdir $sumnt
        mount -t ext4 -o rw,noatime $suimg $sumnt
        for i in 0 1 2 3 4 5 6 7; do
            case `mount` in
                *" $sumnt "*) break;;
            esac;
            loop=/dev/block/loop$i
            if [ ! -f "$loop" -o ! -b "$loop" ]; then
                mknod $loop b 7 $i
            fi
            losetup $loop $suimg && mount -t ext4 -o loop $loop $sumnt
        done

        # Generate module.prop for Magisk
        ui_print "Creating Magisk module $themeId"
        targetParent="$sumnt/$themeId"
        target="$targetParent/system"
        mkdir -p $target
        $vrengine/magisk-setup.sh $vrengine/eviltheme.prop $targetParent
        echo -e "\nthemeSize=$needSizeM\n" >> $vrbackupstaging/eviltheme.prop
    else
        ui_print " * Error: Old Magisk version detected."
        ui_print "   Please update to Magisk 13.1+, or"
        ui_print "   force a non-systemless installation by"
        ui_print "   creating a file called .eviltheme-force-system"
        ui_print "   in your /sdcard."
        cleanup
        exit 1
    fi
else
    ui_print "Installing in system mode"
    mount -o rw,remount /system
    mount /system
    target="$root/system"
fi
set_progress 0.40

# Remove specified files, if any
if [ -e "$vrroot/delete.list" ]; then
    ui_print "Removing files"
    while IFS='' read item; do
        ui_print " => $item"
        filePath="$(dirname $item)"
        fileRoot="$(echo $filePath | cut -f2 -d/)"
        if [ "$SYSTEMLESS" -eq "1" ] && [ "$fileRoot" == "system" ]; then
            # Replace file with empty folder
            # so Magisk can overwrite it by mounting
            filePath="$target/$(echo $filePath | sed 's~/system~~g')"
            mkdir -p "$filePath"
            touch "$filePath/.replace"
        else
            # Allow backup deferring
            deleteParam="$(echo $item | grep -oE '[^ ]+$')"
            if [ "$deleteParam" == "no-backup" ]; then
                [ "$fileRoot" == "system" ] && rm -fr "$root/$item" || rm -fr $item
            else
                # Move file to backup path
                backupPath="$vrbackupstaging/$filePath"
                mkdir -p "$backupPath"
                mv "$item" "$backupPath/"
            fi
        fi
    done < "$vrroot/delete.list"
fi

# Extract new files
ui_print "Installing new files"
echo '' > $vrbackupstaging/delete.list
unzip -o "$ZIPFILE" 'data/*' -d "/"
for f in $(list_new_datafiles $ZIPFILE); do
    echo "/$f" >> $vrbackupstaging/delete.list
done
if [ "$SYSTEMLESS" -eq "1" ]; then
    # No need to handle backups for systemless
    # as the module itself can simply be removed
    unzip -o "$ZIPFILE" 'system/*' -d "$targetParent"
else
    for f in $(list_new_sysfiles $ZIPFILE); do
        if [ -e "/$root/$f" ]; then
            # Copy old files to backup folder
            fileDir="$vrbackupstaging/$(dirname /$root/$f)"
            mkdir -p $fileDir
            cp -fp "/$root/$f" "$fileDir/"
        else
            # Add files to delete.list in restore zip
            echo "/$root/$f" >> $vrbackupstaging/delete.list
        fi
    done
    unzip -o "$ZIPFILE" 'system/*' -d "/$root"
fi

# Start theming
if [ "$HASTHEMEFILES" -eq "1" ]; then
    ui_print "Applying theme"
    [ -d "$vrroot/system/app" ] && theme_app "system" "app"
    [ -d "$vrroot/system/priv-app" ] && theme_app "system" "priv-app"
    [ -d "$vrroot/preload/symlink/system/app" ] && theme_app "preload/symlink/system" "app"
    [ -d "$vrroot/system/framework" ] && theme_framework "system" "framework"
    [ -d "$vrroot/system/framework/samsung-framework-res" ] && theme_framework "system/framework" "samsung-framework-res"
    set_progress 0.80
fi

# Execute custom script
[ -f "$vrengine/custom.sh" ] && $vrengine/custom.sh "$vrengine/recovery-utils.sh" "$ZIPFILE" $SYSTEMLESS "$targetParent"
set_progress 0.90

# Create flashable restore zip
if [ "$(ls -A $vrbackupstaging/)" ]; then
    ui_print "Creating restore ZIP"
    restoreZip="$vrbackup/$themeId-restore-$TIMESTAMP.zip"
    mkdir -p $vrbackup && cd $vrbackupstaging
    [ "$(cat $vrbackupstaging/bytecode.list)" == "" ] && rm -f $vrbackupstaging/bytecode.list
    [ "$(cat $vrbackupstaging/delete.list)" == "" ] && rm -f $vrbackupstaging/delete.list
    $vrengine/zip -r9 "$vrroot/restore_template.zip" .
    mv "$vrroot/restore_template.zip" "$restoreZip"
    set_progress 0.95
fi

# Set permissions
ui_print "Setting permissions"
[ "$SYSTEMLESS" -eq "1" ] && rootDir="$targetParent" || rootDir="$root"
[ -f "$vrengine/permissions.sh" ] && $vrengine/perms.sh $SYSTEMLESS $rootDir
if [ "$HASTHEMEFILES" -eq "1" ]; then
    [ -d "$vrroot/system/app" ] && set_perm_recursive 0 0 0755 0644 "$rootDir/system/app"
    [ -d "$vrroot/system/priv-app" ] && set_perm_recursive 0 0 0755 0644 "$rootDir/system/priv-app"
    [ -d "$vrroot/preload/symlink/system/app" ] && set_perm_recursive 0 0 0755 0644 "/preload/symlink/system/app"
    [ -d "$vrroot/system/framework" ] && set_perm_recursive 0 0 0755 0644 "$rootDir/system/framework"
    [ -d "$vrroot/system/framework/samsung-framework-res" ] && set_perm_recursive 0 0 0755 0644 "$rootDir/system/framework/samsung-framework-res"  
fi

# Cleanup
cleanup
set_progress 1.00

# Goodbye
ui_print "Done."
[ "$SYSTEMLESS" -eq "0" ] && ui_print "" && ui_print "To uninstall, flash $restoreZip."
ui_print ""
set_progress 1.34
exit 0
